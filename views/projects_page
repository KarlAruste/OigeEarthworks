import streamlit as st
from datetime import date
from db import list_projects, create_project, set_project_landxml
from r2 import get_s3, project_prefix, ensure_project_marker, list_files, upload_file, download_bytes, delete_key
from landxml import parse_landxml_total_volume

def render_projects_page():
    st.title("Projects")

    s3 = get_s3()

    # Create project
    st.markdown('<div class="block">', unsafe_allow_html=True)
    st.subheader("‚ûï Loo projekt")
    c1, c2, c3 = st.columns([2,1,1])
    with c1:
        name = st.text_input("Projekti nimi", placeholder="nt Objekt_01")
    with c2:
        start = st.date_input("Algus (valikuline)", value=None)
    with c3:
        end = st.date_input("L√µpp (t√§htaeg)", value=date.today())

    if st.button("Loo projekt", use_container_width=True):
        if not name.strip():
            st.warning("Sisesta projekti nimi.")
        else:
            create_project(name.strip(), start_date=start, end_date=end)
            ensure_project_marker(s3, project_prefix(name.strip()))
            st.success("Projekt loodud.")
            st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

    projects = list_projects()
    if not projects:
        st.info("Pole veel projekte.")
        return

    # Select project by ID, show name (no IDs shown)
    project_id = st.selectbox(
        "Vali projekt",
        options=[p["id"] for p in projects],
        format_func=lambda pid: next(x["name"] for x in projects if x["id"] == pid),
    )
    p = next(x for x in projects if x["id"] == project_id)
    prefix = project_prefix(p["name"])

    # Project header info
    planned = p.get("planned_volume_m3")
    planned_str = f"{float(planned):.2f} m¬≥" if planned is not None else "‚Äî"
    st.caption(f"Projekt: **{p['name']}** ‚Ä¢ T√§htaeg: **{p.get('end_date')}** ‚Ä¢ LandXML maht: **{planned_str}**")

    # LandXML upload
    st.markdown('<div class="block">', unsafe_allow_html=True)
    st.subheader("üìê LandXML (planeeritud mahud)")
    landxml = st.file_uploader("Laadi LandXML √ºles (projekti planeeritud mahud)", type=["xml"], accept_multiple_files=False)

    if landxml is not None:
        # store in R2
        landxml_key = upload_file(s3, prefix, landxml, force_name="plan.landxml.xml")
        xml_bytes = download_bytes(s3, landxml_key)
        vol = parse_landxml_total_volume(xml_bytes)

        if vol is None:
            st.warning("LandXML-ist ei leidnud automaatselt mahu v√§√§rtust. (J√§rgmine samm: t√§psem parser).")
        else:
            st.success(f"Leitud planeeritud maht: {vol:.2f} m¬≥")

        set_project_landxml(project_id, landxml_key, vol)
        st.rerun()

    st.markdown('</div>', unsafe_allow_html=True)

    # Files
    st.markdown('<div class="block">', unsafe_allow_html=True)
    st.subheader("üì§ Failid (Cloudflare R2)")
    uploads = st.file_uploader("Laadi √ºles failid", accept_multiple_files=True)
    if uploads:
        for up in uploads:
            upload_file(s3, prefix, up)
        st.success(f"√úles laaditud {len(uploads)} faili.")
        st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

    st.subheader("üìÑ Projekti failid")
    files = list_files(s3, prefix)
    if not files:
